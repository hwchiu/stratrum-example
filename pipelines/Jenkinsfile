pipeline {
    agent {
        docker { 
            image 'ubuntu:18.04' 
            args '-u root:sudo'
        }
    }
    environment {
        KUBECONFIG = credentials("${params.k8s_config}")
    }
    stages {
        stage('Install tools') {
            steps {
                sh '''
                set -x
                apt-get update -y
                apt-get install -y curl wget jq git
                
                # Install kubectl
                curl -LO "https://storage.googleapis.com/kubernetes-release/release/v1.18.0/bin/linux/amd64/kubectl"
                chmod +x ./kubectl
                mv ./kubectl /usr/local/bin/kubectl
                    
                # Test Kubectl & Rancher
                kubectl get nodes
                '''
            }
        }
        stage('Parallel Stage') {
            parallel {
                stage('onos') {
                    steps {
                        sh(script: "date -u")
                        build(job: "${params.job_name}-onos")
                    }
                }
                stage('stratum') {
                    steps {
                        sh(script: "date -u")
                        build(job: "${params.job_name}-stratum")
                    }
                }
                stage('telegraf') {
                    steps {
                        sh(script: "date -u")
                        build(job: "${params.job_name}-telegraf")
                    }
                }                
            }
        }
        stage('E2E Testing') {
            options {
                timeout(time: 50, unit: "SECONDS")
            }
            steps {
                sh """

                #Wait
cat <<EOF > test.yaml
apiVersion: v1
kind: Pod
metadata:
  name: test
  labels:
    name: test
spec:
  containers:
  - name: test
    image: alpine:3.12.0
    command: ["sh", "-c", "until ping ${params.target_server} -c1 -W 4; do echo 'ping retry'; sleep 3; done;"]
  restartPolicy: Never
EOF

                kubectl apply -f test.yaml
                if [ ! -z "${params.target_server}" ]; then
                    until [ "\$(kubectl get pods --no-headers test -o custom-columns=':.status.phase')" = "Succeeded" ]; do echo 'wait ping completed'; sleep 5; done;
                fi 
                """
             }
        }          
    }
    post { 
        always { 
            cleanWs()
            kubectl delete pod test || true
        }
    }    
}

